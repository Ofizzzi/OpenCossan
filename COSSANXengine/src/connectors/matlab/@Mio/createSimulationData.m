function XsimOut = createSimulationData(Xmio,Poutput)

switch class(Poutput)
    case 'double'
        % check that the number of returned quantities is correct
        assert(size(Poutput,2)==length(Xmio.Coutputnames),...
            'openCOSSAN:mio:createSimulationOutput',...
            ['Wrong number of outputs returned by script/function.\n'... 
            'Nr. of required outputs: %d\n'...
            'Nr. of columns of output matrix: %d'],...
            length(Xmio.Coutputnames),size(Poutput,2))
        % create the simulation data
        XsimOut    = SimulationData('Cnames',Xmio.Coutputnames,'Mvalues',Poutput);
    case 'struct'
        % check that all the required outputs are available as field of the
        % output structure
        Cnames = fieldnames(Poutput);
        assert(all(ismember(Xmio.Coutputnames,Cnames)),...
            'openCOSSAN:mio:createSimulationOutput',...
            ['Not all the necessary outputs are contained in the output structure.\n'...
            'Missing outputs: %s'], ...
            sprintf('%s\n',Xmio.Coutputnames{~ismember(Xmio.Coutputnames,Cnames)}))
        
        % check that no empty values are returned into the structure
        for ifield=1:length(Cnames)
            Ctemp = {Poutput.(Cnames{ifield})};
            LemptyCell = cellfun('isempty',Ctemp);
            assert(~any(LemptyCell),...
                'openCOSSAN:mio:createSimulationOutput',...
                ['Output of name %s returned an empty quantity for samples %s.\n',...
                'Please ensure that your script or function alway return non-empty quantities.'],...
                Cnames{ifield},num2str(find(LemptyCell),'%d,'))
        end
        % create the simulation data
        XsimOut    = SimulationData('Tvalues',Poutput);
    otherwise
        error('openCOSSAN:mio:createSimulationOutput',...
            'Unsupported output from Mio of type %s', class(Poutput))
end

%% Check Outputs
for n=1:length(Xmio.Coutputnames)
    assert(any(strcmp(XsimOut.Cnames,Xmio.Coutputnames(n))), ...
        'openCOSSAN:connectors:mio',...
        ['Output variable ' Xmio.Coutputnames{n} ...
        ' not created by the Mio script (' Xmio.Sdescription ')'] )
end

%% Export results
XsimOut.Sdescription = 'generated by: run(@mio)';   %Sets description of Output object

end